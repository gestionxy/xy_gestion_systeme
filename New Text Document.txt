import plotly.express as px
import pandas as pd
from datetime import timedelta
import streamlit as st

def analyze_unpaid_accounts():
    """
    ä¸»å‡½æ•°ï¼šåˆ†æåº”ä»˜è´¦æ¬¾æ•°æ®ï¼Œç”Ÿæˆæœˆåº¦å’Œå‘¨åº¦è¶‹åŠ¿å›¾è¡¨
    åŠŸèƒ½åŒ…æ‹¬ï¼š
    1. æœˆåº¦æœªä»˜æ¬¾é‡‘é¢è¶‹åŠ¿åˆ†æ
    2. å‘¨åº¦æœªä»˜æ¬¾é‡‘é¢è¶‹åŠ¿åˆ†æ  
    3. éƒ¨é—¨åº”ä»˜å·®é¢æŸ±çŠ¶å›¾å’Œé¥¼çŠ¶å›¾
    """
    
    # ============================================================================
    # ç¬¬ä¸€éƒ¨åˆ†ï¼šæ•°æ®åŠ è½½ä¸åŸºç¡€å¤„ç†
    # ============================================================================
    
    # 1. åŠ è½½ä¾›åº”å•†æ•°æ®
    df_unpaid_zhexiantu = load_supplier_data()
    
    # 2. æ•°æ®æ¸…ç†å’Œç±»å‹è½¬æ¢
    print("å¼€å§‹æ•°æ®æ¸…ç†...")
    
    # å°†å‘ç¥¨é‡‘é¢å’Œå®é™…æ”¯ä»˜é‡‘é¢è½¬æ¢ä¸ºæ•°å€¼ç±»å‹ï¼Œå¤„ç†å¼‚å¸¸å€¼å’Œç©ºå€¼
    df_unpaid_zhexiantu['å‘ç¥¨é‡‘é¢'] = pd.to_numeric(
        df_unpaid_zhexiantu['å‘ç¥¨é‡‘é¢'], errors='coerce'
    ).fillna(0)
    
    df_unpaid_zhexiantu['å®é™…æ”¯ä»˜é‡‘é¢'] = pd.to_numeric(
        df_unpaid_zhexiantu['å®é™…æ”¯ä»˜é‡‘é¢'], errors='coerce'
    ).fillna(0)
    
    # 3. è®¡ç®—å®é™…å·®é¢ï¼ˆæ ¸å¿ƒæŒ‡æ ‡ï¼šæœªä»˜æ¬¾é‡‘é¢ï¼‰
    # å®é™…å·®é¢ = å‘ç¥¨é‡‘é¢ - å®é™…æ”¯ä»˜é‡‘é¢
    # æ­£å€¼è¡¨ç¤ºè¿˜æœ‰æœªä»˜æ¬¾ï¼Œè´Ÿå€¼è¡¨ç¤ºå¤šä»˜æ¬¾
    df_unpaid_zhexiantu['å®é™…å·®é¢'] = (
        df_unpaid_zhexiantu['å‘ç¥¨é‡‘é¢'] - df_unpaid_zhexiantu['å®é™…æ”¯ä»˜é‡‘é¢']
    )
    
    # 4. å¤„ç†å‘ç¥¨æ—¥æœŸï¼Œè½¬æ¢ä¸ºdatetimeæ ¼å¼
    df_unpaid_zhexiantu['å‘ç¥¨æ—¥æœŸ'] = pd.to_datetime(
        df_unpaid_zhexiantu['å‘ç¥¨æ—¥æœŸ'], errors='coerce'
    )
    
    # 5. åˆ›å»ºæœˆä»½åˆ—ï¼Œç”¨äºæœˆåº¦åˆ†æï¼ˆæ ¼å¼ï¼šYYYY-MMï¼‰
    df_unpaid_zhexiantu['æœˆä»½'] = (
        df_unpaid_zhexiantu['å‘ç¥¨æ—¥æœŸ'].dt.to_period('M').astype(str)
    )
    
    print("æ•°æ®æ¸…ç†å®Œæˆ")
    
    # ============================================================================
    # ç¬¬äºŒéƒ¨åˆ†ï¼šæœˆåº¦æ•°æ®æ±‡æ€»ä¸åˆ†æ
    # ============================================================================
    
    print("å¼€å§‹æœˆåº¦æ•°æ®æ±‡æ€»...")
    
    # 6. æŒ‰éƒ¨é—¨å’Œæœˆä»½æ±‡æ€»æœªä»˜æ¬¾é‡‘é¢
    # è¿™æ˜¯æ ¸å¿ƒæ±‡æ€»è¡¨ï¼Œæ¯è¡Œä»£è¡¨ä¸€ä¸ªéƒ¨é—¨åœ¨æŸä¸ªæœˆçš„æœªä»˜æ¬¾æ€»é¢
    unpaid_summary = (
        df_unpaid_zhexiantu
        .groupby(['éƒ¨é—¨', 'æœˆä»½'])['å®é™…å·®é¢']
        .sum()
        .reset_index()
    )
    
    # 7. è®¡ç®—è¾…åŠ©ç»Ÿè®¡æ•°æ®å­—å…¸
    # 7.1 æ¯æœˆæ€»æœªä»˜æ¬¾é‡‘é¢å­—å…¸ {æœˆä»½: æ€»æœªä»˜é‡‘é¢}
    monthly_totals_dict = (
        df_unpaid_zhexiantu
        .groupby('æœˆä»½')['å®é™…å·®é¢']
        .sum()
        .to_dict()
    )
    
    # 7.2 æ¯æœˆæ€»å‘ç¥¨é‡‘é¢å­—å…¸ {æœˆä»½: æ€»å‘ç¥¨é‡‘é¢}
    monthly_invoice_totals_dict = (
        df_unpaid_zhexiantu
        .groupby('æœˆä»½')['å‘ç¥¨é‡‘é¢']
        .sum()
        .to_dict()
    )
    
    # 8. å°†æœˆåº¦æ€»è®¡æ•°æ®æ˜ å°„åˆ°æ±‡æ€»è¡¨ä¸­
    unpaid_summary['æ€»å‘ç¥¨é‡‘é¢'] = unpaid_summary['æœˆä»½'].map(monthly_invoice_totals_dict)
    unpaid_summary['æ€»æœªä»˜é‡‘é¢'] = unpaid_summary['æœˆä»½'].map(monthly_totals_dict)
    
    # 9. è®¡ç®—ç´¯è®¡æœªä»˜æ¬¾é‡‘é¢ï¼ˆæˆªæ­¢åˆ°æ¯æœˆçš„ç´¯è®¡å€¼ï¼‰
    print("è®¡ç®—ç´¯è®¡æœªä»˜æ¬¾é‡‘é¢...")
    
    # 9.1 è·å–æ‰€æœ‰æœˆä»½å¹¶æŒ‰æ—¶é—´æ’åº
    sorted_months = sorted(df_unpaid_zhexiantu['æœˆä»½'].unique())
    
    # 9.2 é€æœˆè®¡ç®—ç´¯è®¡æœªä»˜é‡‘é¢
    cumulative_unpaid_dict = {}
    cumulative_sum = 0
    
    for month in sorted_months:
        # è·å–å½“æœˆæœªä»˜æ€»é¢
        current_month_sum = monthly_totals_dict.get(month, 0)
        # ç´¯åŠ åˆ°æ€»å’Œ
        cumulative_sum += current_month_sum
        # è®°å½•ç´¯è®¡å€¼
        cumulative_unpaid_dict[month] = cumulative_sum
    
    # 9.3 å°†ç´¯è®¡å€¼æ˜ å°„åˆ°æ±‡æ€»è¡¨
    unpaid_summary['ç´¯è®¡æœªä»˜é‡‘é¢'] = unpaid_summary['æœˆä»½'].map(cumulative_unpaid_dict)
    
    # 10. ç”Ÿæˆæœˆåº¦å›¾è¡¨çš„hoveræç¤ºä¿¡æ¯
    unpaid_summary['æç¤ºä¿¡æ¯'] = unpaid_summary.apply(
        lambda row: (
            f"ğŸ”¹æˆªæ­¢åˆ°{row['æœˆä»½'][:4]}å¹´{row['æœˆä»½'][5:]}æœˆ <br>"
            f"ç´¯è®¡æœªä»˜é‡‘é¢ï¼š{row['ç´¯è®¡æœªä»˜é‡‘é¢']:,.0f}<br>"
            f"å½“æœˆæœªä»˜é‡‘é¢ï¼š{row['æ€»æœªä»˜é‡‘é¢']:,.0f}<br>"
            f"å½“æœˆ æ–°å¢å‘ç¥¨æ€»é‡‘é¢ï¼š{monthly_invoice_totals_dict.get(row['æœˆä»½'], 0):,.0f}<br>"
            f"<br>"
            f"éƒ¨é—¨ï¼š{row['éƒ¨é—¨']}<br>"
            f"å½“æœˆæœªä»˜é‡‘é¢ï¼š{row['å®é™…å·®é¢']:,.0f}<br>"
            f"å æ¯”ï¼š{row['å®é™…å·®é¢'] / monthly_invoice_totals_dict.get(row['æœˆä»½'], 1):.1%}"
        ),
        axis=1
    )
    
    # ============================================================================
    # ç¬¬ä¸‰éƒ¨åˆ†ï¼šç”Ÿæˆéƒ¨é—¨é¢œè‰²æ˜ å°„å’Œæœˆåº¦å›¾è¡¨
    # ============================================================================
    
    # 11. ä¸ºå„éƒ¨é—¨ç”Ÿæˆä¸€è‡´çš„é¢œè‰²æ˜ å°„
    unique_departments = sorted(unpaid_summary['éƒ¨é—¨'].unique())
    colors = px.colors.qualitative.Dark24
    color_map = {
        dept: colors[i % len(colors)] 
        for i, dept in enumerate(unique_departments)
    }
    
    # 12. ç»˜åˆ¶æœˆåº¦æŠ˜çº¿å›¾
    print("ç”Ÿæˆæœˆåº¦è¶‹åŠ¿å›¾...")
    
    fig_month = px.line(
        unpaid_summary,
        x="æœˆä»½",
        y="å®é™…å·®é¢",
        color="éƒ¨é—¨",
        title="å„éƒ¨é—¨æ¯æœˆæœªä»˜è´¦é‡‘é¢",
        markers=True,
        labels={"å®é™…å·®é¢": "æœªä»˜è´¦é‡‘é¢", "æœˆä»½": "æœˆä»½"},
        line_shape="linear",
        color_discrete_map=color_map,
        hover_data={'æç¤ºä¿¡æ¯': True}
    )
    
    # æ·»åŠ æ•°æ®æ ‡ç­¾
    fig_month.update_traces(
        text=unpaid_summary["å®é™…å·®é¢"].round(0).astype(int),
        textposition="top center",
        hovertemplate="%{customdata[0]}"
    )
    
    # 13. æ˜¾ç¤ºæœˆåº¦å›¾è¡¨
    st.plotly_chart(fig_month, key="monthly_unpaid_chart001")
    
    # ============================================================================
    # ç¬¬å››éƒ¨åˆ†ï¼šå‘¨åº¦æ•°æ®å¤„ç†ä¸åˆ†æ
    # ============================================================================
    
    print("å¼€å§‹å‘¨åº¦æ•°æ®å¤„ç†...")
    
    # 14. è®¡ç®—æ¯ä¸ªå‘ç¥¨æ—¥æœŸå¯¹åº”çš„å‘¨èŒƒå›´ï¼ˆå‘¨ä¸€åˆ°å‘¨æ—¥ï¼‰
    # 14.1 è®¡ç®—å‘¨å¼€å§‹æ—¥æœŸï¼ˆå‘¨ä¸€ï¼‰
    df_unpaid_zhexiantu['å‘¨å¼€å§‹'] = (
        df_unpaid_zhexiantu['å‘ç¥¨æ—¥æœŸ'] - 
        pd.to_timedelta(df_unpaid_zhexiantu['å‘ç¥¨æ—¥æœŸ'].dt.weekday, unit='D')
    )
    
    # 14.2 è®¡ç®—å‘¨ç»“æŸæ—¥æœŸï¼ˆå‘¨æ—¥ï¼‰
    df_unpaid_zhexiantu['å‘¨ç»“æŸ'] = df_unpaid_zhexiantu['å‘¨å¼€å§‹'] + timedelta(days=6)
    
    # 14.3 ç”Ÿæˆå‘¨èŒƒå›´å­—ç¬¦ä¸²ï¼ˆæ ¼å¼ï¼šYYYY-MM-DD ~ YYYY-MM-DDï¼‰
    df_unpaid_zhexiantu['å‘¨èŒƒå›´'] = (
        df_unpaid_zhexiantu['å‘¨å¼€å§‹'].dt.strftime('%Y-%m-%d') + 
        ' ~ ' + 
        df_unpaid_zhexiantu['å‘¨ç»“æŸ'].dt.strftime('%Y-%m-%d')
    )
    
    # 15. æä¾›æœˆä»½é€‰æ‹©å™¨ç»™ç”¨æˆ·
    valid_months = sorted(df_unpaid_zhexiantu['æœˆä»½'].unique())
    selected_month = st.selectbox(
        "ğŸ”é€‰æ‹©æŸ¥çœ‹å…·ä½“å‘¨æ•°æ®çš„æœˆä»½", 
        valid_months, 
        index=len(valid_months) - 1
    )
    
    # 16. è·å–é€‰å®šæœˆä»½æ¶‰åŠçš„æ‰€æœ‰å‘¨èŒƒå›´
    # åŒ…æ‹¬è·¨æœˆçš„å‘¨ï¼ˆå‘¨çš„ä¸€éƒ¨åˆ†åœ¨é€‰å®šæœˆä»½å†…ï¼‰
    week_ranges = df_unpaid_zhexiantu[
        (df_unpaid_zhexiantu['å‘ç¥¨æ—¥æœŸ'].dt.to_period('M').astype(str) == selected_month) |
        (df_unpaid_zhexiantu['å‘¨å¼€å§‹'].dt.to_period('M').astype(str) == selected_month) |
        (df_unpaid_zhexiantu['å‘¨ç»“æŸ'].dt.to_period('M').astype(str) == selected_month)
    ]['å‘¨èŒƒå›´'].unique()
    
    # 17. æŒ‰å‘¨å’Œéƒ¨é—¨æ±‡æ€»æœªä»˜æ¬¾é‡‘é¢
    weekly_summary_filtered = (
        df_unpaid_zhexiantu[
            (df_unpaid_zhexiantu['å‘¨èŒƒå›´'].isin(week_ranges)) &
            (df_unpaid_zhexiantu['å‘ç¥¨æ—¥æœŸ'] >= df_unpaid_zhexiantu['å‘¨å¼€å§‹']) &
            (df_unpaid_zhexiantu['å‘ç¥¨æ—¥æœŸ'] <= df_unpaid_zhexiantu['å‘¨ç»“æŸ'])
        ]
        .groupby(['éƒ¨é—¨', 'å‘¨èŒƒå›´', 'å‘¨å¼€å§‹', 'å‘¨ç»“æŸ'])['å®é™…å·®é¢']
        .sum()
        .reset_index()
    )
    
    # 18. ç¡®ä¿å‘¨åº¦æ•°æ®æŒ‰æ—¶é—´é¡ºåºæ’åˆ—
    weekly_summary_filtered['å‘¨å¼€å§‹'] = pd.to_datetime(weekly_summary_filtered['å‘¨å¼€å§‹'])
    weekly_summary_filtered = weekly_summary_filtered.sort_values(by='å‘¨å¼€å§‹').reset_index(drop=True)
    
    # 19. è®¡ç®—å‘¨åº¦ç»Ÿè®¡å­—å…¸
    # 19.1 æ¯å‘¨æ€»æœªä»˜æ¬¾é‡‘é¢å­—å…¸
    weekly_totals_dict = (
        df_unpaid_zhexiantu[df_unpaid_zhexiantu['å‘¨èŒƒå›´'].isin(week_ranges)]
        .groupby('å‘¨èŒƒå›´')['å®é™…å·®é¢']
        .sum()
        .to_dict()
    )
    
    # 19.2 æ¯å‘¨æ€»å‘ç¥¨é‡‘é¢å­—å…¸
    weekly_invoice_totals_dict = (
        df_unpaid_zhexiantu[df_unpaid_zhexiantu['å‘¨èŒƒå›´'].isin(week_ranges)]
        .groupby('å‘¨èŒƒå›´')['å‘ç¥¨é‡‘é¢']
        .sum()
        .to_dict()
    )
    
    # 20. å°†å‘¨åº¦æ€»è®¡æ•°æ®æ˜ å°„åˆ°å‘¨æ±‡æ€»è¡¨
    weekly_summary_filtered['æ€»å‘ç¥¨é‡‘é¢'] = weekly_summary_filtered['å‘¨èŒƒå›´'].map(weekly_invoice_totals_dict)
    weekly_summary_filtered['æ€»æœªä»˜é‡‘é¢'] = weekly_summary_filtered['å‘¨èŒƒå›´'].map(weekly_totals_dict)
    
    # 21. è®¡ç®—å‘¨åº¦ç´¯è®¡æœªä»˜æ¬¾é‡‘é¢
    print("è®¡ç®—å‘¨åº¦ç´¯è®¡æœªä»˜æ¬¾é‡‘é¢...")
    
    # 21.1 æŒ‰å‘¨èŒƒå›´æ±‡æ€»ï¼Œè®¡ç®—æ¯å‘¨æ€»æœªä»˜é‡‘é¢
    df_week_accumulation_unpaid = (
        df_unpaid_zhexiantu
        .groupby('å‘¨èŒƒå›´')['å®é™…å·®é¢']
        .sum()
        .reset_index(name='å®é™…å·®é¢')
    )
    
    # 21.2 è®¡ç®—ç´¯è®¡æœªä»˜é‡‘é¢ï¼ˆæŒ‰å‘¨èŒƒå›´å­—ç¬¦ä¸²æ’åºåç´¯åŠ ï¼‰
    df_week_accumulation_unpaid['ç´¯è®¡æœªä»˜é‡‘é¢'] = df_week_accumulation_unpaid['å®é™…å·®é¢'].cumsum()
    
    # 21.3 å°†ç´¯è®¡å€¼æ˜ å°„åˆ°å‘¨æ±‡æ€»è¡¨
    weekly_summary_filtered['ç´¯è®¡æœªä»˜é‡‘é¢'] = weekly_summary_filtered['å‘¨èŒƒå›´'].map(
        df_week_accumulation_unpaid.set_index('å‘¨èŒƒå›´')['ç´¯è®¡æœªä»˜é‡‘é¢']
    )
    
    # 22. ç”Ÿæˆå‘¨åº¦å›¾è¡¨çš„hoveræç¤ºä¿¡æ¯
    weekly_summary_filtered['æç¤ºä¿¡æ¯'] = weekly_summary_filtered.apply(
        lambda row: (
            f"ğŸ”¹ æˆªæ­¢è‡³{row['å‘¨èŒƒå›´']}<br>"
            f"ç´¯è®¡æœªä»˜é‡‘é¢ï¼š{row['ç´¯è®¡æœªä»˜é‡‘é¢']:,.0f}<br>"
            f"æœ¬å‘¨å‘ç¥¨é‡‘é¢ï¼š{row['æ€»å‘ç¥¨é‡‘é¢']:,.0f}<br>"
            f"æœ¬å‘¨æœªä»˜é‡‘é¢ï¼š{row['æ€»æœªä»˜é‡‘é¢']:,.0f}<br>"
            f"æœ¬å‘¨æœªä»˜æ¯”ä¾‹ï¼š{row['æ€»æœªä»˜é‡‘é¢'] / row['æ€»å‘ç¥¨é‡‘é¢']:.1%}<br>"
            f"<br>"
            f"éƒ¨é—¨ï¼š{row['éƒ¨é—¨']}<br>"
            f"æœªä»˜é‡‘é¢ï¼š{row['å®é™…å·®é¢']:,.0f}<br>"
            f"å æ¯”ï¼š{row['å®é™…å·®é¢'] / row['æ€»å‘ç¥¨é‡‘é¢']:.1%}"
        ),
        axis=1
    )
    
    # 23. ç»˜åˆ¶å‘¨åº¦æŠ˜çº¿å›¾
    print("ç”Ÿæˆå‘¨åº¦è¶‹åŠ¿å›¾...")
    
    fig_week = px.line(
        weekly_summary_filtered,
        x="å‘¨èŒƒå›´",
        y="å®é™…å·®é¢",
        color="éƒ¨é—¨",
        title=f"{selected_month} æ¯å‘¨å„éƒ¨é—¨æœªä»˜è´¦é‡‘é¢",
        markers=True,
        labels={"å®é™…å·®é¢": "æœªä»˜è´¦é‡‘é¢", "å‘¨èŒƒå›´": "å‘¨"},
        line_shape="linear",
        color_discrete_map=color_map,
        hover_data={'æç¤ºä¿¡æ¯': True},
        category_orders={"å‘¨èŒƒå›´": weekly_summary_filtered['å‘¨èŒƒå›´'].tolist()}
    )
    
    # æ·»åŠ æ•°æ®æ ‡ç­¾
    fig_week.update_traces(
        text=weekly_summary_filtered["å®é™…å·®é¢"].round(0).astype(int),
        textposition="top center",
        hovertemplate="%{customdata[0]}"
    )
    
    # 24. æ˜¾ç¤ºå‘¨åº¦å›¾è¡¨
    st.plotly_chart(fig_week, key="weekly_unpaid_chart001")
    
    # ============================================================================
    # ç¬¬äº”éƒ¨åˆ†ï¼šéƒ¨é—¨åº”ä»˜å·®é¢ç»Ÿè®¡å›¾è¡¨
    # ============================================================================
    
    print("ç”Ÿæˆéƒ¨é—¨ç»Ÿè®¡å›¾è¡¨...")
    
    # 25. ç”Ÿæˆéƒ¨é—¨åº”ä»˜å·®é¢æŸ±çŠ¶å›¾
    # æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨äº†filtered_time_onlyå˜é‡ï¼Œéœ€è¦ç¡®ä¿è¯¥å˜é‡å·²å®šä¹‰
    # å‡è®¾è¿™æ˜¯ç»è¿‡æ—¶é—´ç­›é€‰åçš„æ•°æ®
    bar_df = filtered_time_only.groupby("éƒ¨é—¨")[['åº”ä»˜æœªä»˜å·®é¢']].sum().reset_index()
    bar_df['åº”ä»˜æœªä»˜å·®é¢'] = bar_df['åº”ä»˜æœªä»˜å·®é¢'].round(0).astype(int)
    
    fig_bar = px.bar(
        bar_df,
        x="éƒ¨é—¨",
        y="åº”ä»˜æœªä»˜å·®é¢",
        color="éƒ¨é—¨",
        title="é€‰ä¸­éƒ¨é—¨åº”ä»˜æœªä»˜å·®é¢",
        text="åº”ä»˜æœªä»˜å·®é¢",
        labels={"åº”ä»˜æœªä»˜å·®é¢": "é‡‘é¢ï¼ˆ$ CADï¼‰"},
        color_discrete_map=color_map
    )
    fig_bar.update_traces(textposition="outside")
    
    # 26. ç”Ÿæˆéƒ¨é—¨åº”ä»˜å·®é¢é¥¼çŠ¶å›¾
    fig_pie = px.pie(
        bar_df,
        names="éƒ¨é—¨",
        values="åº”ä»˜æœªä»˜å·®é¢",
        title="æ‰€æœ‰éƒ¨é—¨å æ€»åº”ä»˜å·®é¢æ¯”ä¾‹",
        labels={"åº”ä»˜æœªä»˜å·®é¢": "é‡‘é¢ï¼ˆ$ CADï¼‰"},
        hole=0.4,
        color_discrete_map=color_map
    )
    
    fig_pie.update_traces(
        marker=dict(colors=[color_map.get(dept, '#CCCCCC') for dept in bar_df['éƒ¨é—¨']])
    )
    
    # 27. æ˜¾ç¤ºæŸ±çŠ¶å›¾å’Œé¥¼çŠ¶å›¾
    st.plotly_chart(fig_bar)
    st.plotly_chart(fig_pie)
    
    print("æ‰€æœ‰å›¾è¡¨ç”Ÿæˆå®Œæˆï¼")

# ============================================================================
# ä¸»ç¨‹åºæ‰§è¡Œ
# ============================================================================

if __name__ == "__main__":
    # æ‰§è¡Œåº”ä»˜è´¦æ¬¾åˆ†æ
    analyze_unpaid_accounts()